* [2021-1-20 Wed] - possible topics for impedance methods paper 
** comparison of linear chirp, logarithmic chirp, white noise
*** also maybe neuron tool and/or method from pyramidal paper 
*** slew rate 
** srdjan's suggestion regarding poor access 
** analysis of asymmetric chirp response 
*** for instance, Rich2020-yl fig7 1.5 mV difference 
 
* [2021-1-28 Thu] - asym chirp response 
** asymmetric chirp response 
*** logspaced amplitude from 0.01 to 0.31 
*** want to plot assymetry (mV) vs mean squared error 
*** asymmetric.py: v0.01 - sensitivity analysis of asymmetric voltage responses in computing impedance

* [2021-1-29 Fri] - more asym chirp response 
** results from yesterday 
*** rerunning the sim because screwed up asymmetry calculation 
*** MSE increases exponentially w/ current amplitude anyway
**** much larger errors in amplitude than phase 
*** examples subfig 
from getCells import M1Cell   
s = M1Cell()  
seg = s.net.cells[0].secs['soma']['hObj'](0.5)   
from neuron import h, gui    
import numpy as np  
from chirpUtils import getChirp, applyChirpZin  
from sklearn.metrics import mean_squared_error 
 
amps = np.logspace(np.log10(0.015), np.log10(0.31), num=9, endpoint=True) 
 
f0, f1, t0, Fs, delay = 0.5, 20, 20, 1000, 5 
 
phaseErr = [] 
ampErr = [] 
asym = [] 
 
soma_v = h.Vector().record(seg._ref_v)      
time = h.Vector().record(h._ref_t)  
 
amp = 0.01  
print('Running ' + str(amp)) 
I, t = getChirp(f0, f1, t0, amp, Fs, delay) 
base = applyChirpZin(I, t, seg, t0, delay, Fs, f1)

base_v_trim = [v for v, T in zip(soma_v, time) if 4900 < T < 25100]                  
base_v_trim = np.subtract(base_v_trim, base_v_trim[0])
t_trim = [T for T in time if 4900 < T < 25100] 

amp = amps[-1]
print('Running ' + str(amp)) 
I, t = getChirp(f0, f1, t0, amp, Fs, delay) 
out = applyChirpZin(I, t, seg, t0, delay, Fs, f1)   

v_trim = [v for v, T in zip(soma_v, time) if 4900 < T < 25100]                               
v_trim = np.subtract(v_trim, v_trim[0])

from matplotlib import pyplot as plt
plt.ion()
plt.figure()
plt.subplot(2,3,1)
plt.plot([(T-5100)/1000 for T in t_trim], base_v_trim, label='0.01 mV', color='black')
plt.title('0.01 mV Assymetry', fontsize=16)
plt.xlabel('Time (s)', fontsize=14)
plt.ylabel(r'$\Delta$ V$_{memb}$ (mV)', fontsize=14)
plt.ylim(-0.6, 0.6)
plt.xlim(-0.1,20.1)
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
plt.subplot(2,3,4)
plt.plot([(T-5100)/1000 for T in t_trim], v_trim, label='1.20 mV', color='gray')
plt.title('1.20 mV Assymetry', fontsize=16)    
plt.xlabel('Time (s)', fontsize=14)
plt.ylabel(r'$\Delta$ V$_{memb}$ (mV)', fontsize=14)
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
plt.ylim(-18,18)
plt.xlim(-0.1, 20.1)
plt.subplot(2,3,2)
plt.plot(out['Freq'], out['ZinAmp'], label='1.20 mV', color='gray')
plt.plot(base['Freq'], base['ZinAmp'], label='0.01 mV', color='black')
plt.xlabel('Frequency (Hz)', fontsize=14)
plt.ylabel(r'|Z$_{in}$| (M$\Omega$)', fontsize=14)
plt.title('ZAP', fontsize=16)
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
plt.xlim(0,20.5)
plt.subplot(2,3,3)
plt.plot(out['Freq'], out['ZinPhase'], label='1.20 mV', color='gray')
plt.plot(base['Freq'], base['ZinPhase'], label='0.01 mV', color='black')
plt.xlabel('Frequency (Hz)', fontsize=14)
plt.ylabel(r'$\Phi_{in}$ (radians)', fontsize=14)
plt.title('ZPP', fontsize=16)
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
plt.xlim(0,20.5)

* [2021-1-30 Sat] - asym vs mse amp and phase 
** code for plot 
from scipy.io import loadmat 
data = loadmat('asym_sensitivity_v2.mat')
from matplotlib import pyplot as plt 
plt.ion()
import numpy as np
plt.figure()
plt.subplot(2,3,5)
# plt.plot(data['asym'][0], np.sqrt(data['ampErr'][0]), color='k', linestyle='-', linewidth=1.5)
plt.semilogx(data['asym'][0], np.sqrt(data['ampErr'][0]), color='k', linestyle='-', linewidth=1.5)
plt.scatter(data['asym'][0], np.sqrt(data['ampErr'][0]), color='k', linewidth=1.5)
plt.xlabel('Response Assymetry (mV)', fontsize=14)
plt.ylabel(r'Root Mean Squared Error (M$\Omega$)', fontsize=14)
plt.title('ZAP Error', fontsize=16)
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
plt.subplot(2,3,6)
# plt.plot(data['asym'][0], np.sqrt(data['phaseErr'][0]), color='k', linestyle='-', linewidth=1.5)
plt.semilogx(data['asym'][0], np.sqrt(data['phaseErr'][0]), color='k', linestyle='-', linewidth=1.5)
plt.scatter(data['asym'][0], np.sqrt(data['phaseErr'][0]), color='k', linewidth=1.5)
plt.xlabel('Response Assymetry (mV)', fontsize=14)
plt.ylabel(r'Root Mean Squared Error (radians)', fontsize=14)
plt.title('ZPP Error', fontsize=16)
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
** [[responseAssymetry.svg][example traces, ZAPs, and ZPPs, and error graphs]]

* [2021-3-12 Fri] - refactoring code 
** putting together a separate repo from the PT impedance paper 
** rerunning validation code for M1 PT cell for soma 

* [2021-3-15 Mon] - search for K+ mediated resonance 
** looking for decent model exhibiting K+ mediated resonance 
*** granule cell, Dover2016-ov, https://senselab.med.yale.edu/ModelDB/ShowModel?model=206267&file=/GrC_FHF_ModelDB/#tabs-1
**** resonance frequencies around where it is in PTs 
*** DRG, Amir2003-ww, https://senselab.med.yale.edu/ModelDB/ShowModel?model=51022#tabs-1
**** low pass 
*** Izhikevich 2003... not sure I'm using it correctly 

* [2021-4-9 Fri] - getting back into it
** downsample impedance values 
zAmp_red = [] 
zPhase_red = [] 
while freqs_sorted[ind] <= f1: 
    find = np.argmin(np.square(np.subtract(base['Freq'],freqs_sorted[ind]))) 
    zAmp_red.append(base['ZinAmp'][find]) 
    zPhase_red.append(base['ZinPhase'][find]) 
    ind = ind + 1

* [2021-4-11 Sun] - sorting out proper validation 
** need valid impedance value for every estimated one
*** parallelized and generalized impedance validation procedure 
** looking at signal to noise ratio issues (combining noise / subthreshold oscillations + imepdance estimation)

* [2021-4-12 Mon] - log and noise 
** new functions/scripts for adding background noise and runnig log chirp 
** validation for 20 s noise frequencies still running 

* [2021-4-16 Fri] - chirp and noise comparisons 
** put together nice figure of chirp vs. noise comparison
*** should i include log chirp? - yes, log chirp is the best 
** trouble doing linear prediction
*** frequency domain mult and time domain convolution don't look right
*** may be my mistake 

* [2021-4-19 Mon] - noise parameter space 
** varied duration, window size for smoothing, and std of gaussian distribution

* [2021-4-22 Thu] - worked out issues w/ z calculation 
** previously interpolating I that is played into IClamp, now recording i from IClamp 
*** eliminates progressive errors in impedance phase 
*** [[figures/chirp_vs_logchirp_vs_noise_v2.svg][new comparison of log, chirp, and noise]] 
Comparison of using linear chirp, logarithmic chirp, and Gaussian noise 
to compute input impedance.  
Errors were computed against impedance measurements from our validation paradigm. 
Impedance amplitude and phase profiles are unfiltered. 
Top row: Linear and logarithmic chirps had instantaneous frequencies increasing 
from 0.5-20 Hz over 20 s. 
The noise stimulus was 20 s.
Left: In the low frequency range, logarithmic chirp has the largest errors. 
White noise has lower error, but there are transient spikes in |Z$_{in}$| as high 
as 6 M$\Omega$.
Linear chirp has the lowers MSE and good agreement with validated |Z$_{in}| at all
frequencies. 
Right: The same pattern can be seen in $\Phi_{in}$.
Bottom row: Linear and logarithmic chirps had instantaneous frequencies increasing 
from 0.5-500 Hz over 60 s. 
Left:  The largest errors in |Z$_{in}$| were from linear chirp, with errors at 
low frequencies as high as 20 M$\Omega#, but good agreement with validation 
|Z$_{in}$| at higher frequencies.  Logarithmic chirp has lower errors, but follows
a similar pattern.  Noise produces good agreement with validation |Z$_{in}$| across
the frequency spectrum, but still suffers from transient spikes.
Left: Computing $\Phi_{in}$ with gaussian white noise had the largest MSE with 
errors increasing at higher frequencies. Linear and logarithmic chirp have lower 
MSE, but follow the same pattern seen in |Z_{in}| with large errors at low
frequencies.
** comparison of noise durations - longer is better, but only a marginal improvement 
*** [[figures/compareNoiseDuration.svg][comparison of 2s vs 20s of white noise with 5nA std]]
** looking for optimal filter window size
*** [[figures/logChirp_errVsBinSize.svg][error vs bin size, filter before or after trim Z beyond freq lims]]
*** best for logarithmic chirp to filter before removing Z(0.5 < f < 20) w/
window size of 18

* [2021-4-23 Fri] - more optimal filter sizes 
** noise - also before removing Z(0.5 < f < 20) w/ window size of 18 - herre translates to 0.567 Hz 

* [2021-4-25 Sun] - returning to noise and response assymetry
** plusNoise.py: v0.01 - configured for linear chirp over 0.5 - 20 Hz over 50 noise parameter combos
** responseAsym.py: v0.00 - replaces assymetricNoise.py, configured for 20s chirp with amps as high as 0.31 

* [2021-4-26 Mon] - plotting yesterday's sim output 
** plotPlusNoise.py: v0.00 - plot amplitude and phase errs by amp and std of noise 
*** plotPlusNoise.py: v0.01 - adding optimal filter window size
** plusNoise.py - v0.02 - filter window sizes now range from 50-200
** plotAsym.py - v0.00 - plotting output from asymmetric chirp sims 

* [2021-4-27 Tue] - input impedance 
** bill liked, but definitely not thrilled about, existing figures 
** he and srdjan still very keen on access problem 
*** more important an issue in the apical dendrite since pipette tip needs to be
so much smaller 
*** figured out how to change input location in linear circuit builder 

* [2021-7-19 Mon] - circuit builder issues 
** trying to replicate circuit from DeFelice1997-kd, but can't export circuit to .ses  
*** from "Print matrix info": Circuit equations have 0 inconsistencies 
*** error/warning from "Create class":
Unhandled exception in event loop:
Exception None
Press ENTER to continue...                                                                           
NEURON: no label on cell port
 near line 1
 {mkclass()}
^
)
)
)
)
Exception in gui thread

* [2021-7-23 Fri] - progress with circuit builder 
** met with ted
*** wasn't saving session, instead was saving template (.hoc, rather than .ses)
*** need to label nodes, or at lease between cell and circuit 
*** suggested using different circuit layout
from neuron import h, gui 
soma = h.Section(name='soma')
h.load_file('simpleCellCircuit.ses')
*** couldn't get template working other day, just figured out how to attach, 
dont know where Isrc is 
# code
from neuron import h, gui 
soma = h.Section(name='soma')
h.load_file('secondClass.hoc')
lm = h.LM()
lm.Vm_loc(0.5, soma)

* [2021-7-27 Tue] - using fzap and simple model 
** have .ses working for chirp 
*** need to have channels to get RMP 
** olah paper
*** axon diameter:log-normal distribution with mean of 0.6 µm and variance of
0.4 µm2.

* [2021-8-2 Mon] - meeting w/ srdjan and ted today 
** notes for meeting 
*** ted seems to think no need for access resistance and junction potential,
bill and presumably srdjan feel otherwise 
**** two starter versions of the circuit 
***** [[figures/example_run_tedConfig.png][no representation of Racc]]
***** [[figures/example_run_billConfig.png][guessed some vals for Racc and J]]
*** olah paper 
**** could incorporate detailed representation of the pipette
[[figures/detailed_pipette.png][pipette values from olah]]
**** a lot of the paper's focus was on amplifier and other instrumentation - 
do we want to include this kind of detail?
*** srdjan have any useful recordings/data/values for this?
*** new circuit layout [[iclamp_circuit.ses][iclamp with junction potential]]

* [2021-12-9 Thu] - looking at sync freq from vaidya and johnston 
** code for plotting phase for trunk and oblique 
import json
from matplotlib import pyplot as plt 
import numpy as np
fig, axs = plt.subplots(1,2)
trunk = [1, 12, 22]
obliq = [102, 79, 87]
data = []
dists = []
for t in trunk:
    with open('imped_data/M1Cell_apic_' + str(t) + '.json', 'rb') as fileObj:
        tmp = json.load(fileObj)
    dists.append(tmp['dist'])
    data.append(tmp)
inds = np.argsort(dists)
for ind in inds:
    axs[0].plot(data[ind]['Freq'], data[ind]['ZcPhase'], label=str(round(data[ind]['dist']))+' um')
axs[0].set_title('Apical Trunk', fontsize=14)
axs[0].set_ylabel('Transfer Impedance Phase', fontsize=12)
axs[0].set_xlabel('Frequency (Hz)', fontsize=12)
axs[0].legend()
data = []
dists = []
for t in obliq:
    with open('imped_data/M1Cell_apic_' + str(t) + '.json', 'rb') as fileObj:
        tmp = json.load(fileObj)
    dists.append(tmp['dist'])
    data.append(tmp)
inds = np.argsort(dists)
for ind in inds:
    axs[1].plot(data[ind]['Freq'], data[ind]['ZcPhase'], label=str(round(data[ind]['dist']))+' um')
axs[1].set_title('Apical Oblique', fontsize=14)
axs[1].set_xlabel('Frequency (Hz)', fontsize=12)
axs[1].legend()

* [2021-12-13 Mon] - looking at Rich et al 2021 human cell 
** importing 
import os 
os.chdir('models/HumanCellOrganized_v2/')
from neuron import h
h.load_file('stdrun.hoc')
h.load_file('import3d.hoc')
h.load_file('SimulationParameters_PlusSomeDefinitions.hoc')
h.load_file('ModelSetup.hoc')
trunk_secs = [1,3,7,15,24,37,59,85,109,123,131,137,143,145,149,155]

* [2022-2-16 Wed] - suprathreshold/nonlinear phase 
** analog for linear phase - lag between peak of stimulus to somatic AP 
*** similar phase lead at low frequencies
*** seemingly opposite relationship between distance and "synchronous frequency"
*** suprathreshold phase response depends on amplitude / spike rates 
** M1Cell not working anymore 
** possible figs 
*** compare subthreshold to suprathreshold phase 
*** distance dependence 
*** amplitude dependence 
*** different holding currents  

* [2022-3-14 Mon] - phase precession and roll 
** phase roll paper 
*** [[https://paperpile.com/app/p/63a428b5-8425-0bb9-b995-f3c9caee4a5c][Sloin2022-pe]]
** phase roll with constant amplitude sinusoid, phase precession with ramped 
amplitude sinusoid 
** ramped sinusoid phase precession 
*** h-dependent 
*** location dependent 
*** frequency dependent?
*** amplitude / slope dependent?

* [2022-3-17 Thu] 
** DONE - put together basic figures for precession and roll 
** DONE - email kubie about how to frame for the phase precession people 

* [2022-4-7 Thu] - prelim findings fig for proposal 
** plot lag vs. stimulus cycle for ramp and constant chirp 
import json 
import numpy as np 
from matplotlib import pyplot as plt 
plt.ion()
with open('supra_data/HayCellMig_apic_0_amp_1.0_offset_0.0_f0_8_f1_8.json', 'rb') as fileObj:
    control = json.load(fileObj)
with open('supra_data/HayCellMig_apic_0_amp_1.0_offset_0.0_f0_8_f1_8_blockIh.json', 'rb') as fileObj:
    blockIh = json.load(fileObj)
fig, axs = plt.subplots(nrows=1, ncols=2)
axs[0].plot([i+1 for i in range(len(control['lags'])-1)], control['lags'][1:], 'b*-', label='Control')
axs[0].plot([i+1 for i in range(len(blockIh['lags'])-1)], blockIh['lags'][1:], 'r*-', label='Block Ih')
with open('ramp_data/HayCellMig_apic_0_amp_2.0_offset_0.0_f0_8_f1_8.json', 'rb') as fileObj:
    control = json.load(fileObj)
with open('ramp_data/HayCellMig_apic_0_amp_2.0_offset_0.0_f0_8_f1_8_blockIh.json', 'rb') as fileObj:
    blockIh = json.load(fileObj)
axs[1].plot([i+1 for i in range(len(control['lags']))], control['lags'], 'b*-', label='Control')
axs[1].plot([i+1 for i in range(len(blockIh['lags']))], blockIh['lags'], 'r*-', label='Block Ih')

* [2022-6-6 Mon] - getting back into it 
** using hilbert transform to extract phase angle, use angles rather than lags 

* [2022-6-7 Tue] - possible figures 
** 1. subthreshold vs suprathreshold, insufficiency of chirp 
** 2. just traces showing precession and roll 
** 3. precession - location-, amplitude-, frequency-, Ih-dependent 
*** maybe just perisomatic or apical for amp, freq, and Ih 
** 4. roll - location-, amplitude-, frequency-, Ih-dependent
*** same 
** 5. [if rapid report, get rid of 1.] - neuromodulation of precession/roll 

* [2022-6-9 Thu] - sims to run 
** const amplitude 
*** Perisomatic (apic_0)
**** 8Hz, 1.0 nA 
**** 4Hz, 0.56 nA 
*** Apical (apic_36)
**** 8Hz, 3.45 nA 
**** 4Hz, 2.26 nA 
** ramp amplitude 
*** Perisomatic (apic_0)
**** 8 Hz, 1.9 nA 
**** 4 Hz, 1.9 nA 
*** Apical (apic_36)
**** 8 Hz, 3.9 nA 
**** 4 Hz, 4.0 nA 

* [2022-6-23 Thu] - sfn abs, figs, vaidya stim protocol
** submitted abstract for sfn 
*** [[https://docs.google.com/document/d/18zPJFahz_G0opLqehJZI-OZaTqGrtxBP5aGvtcE1FnE/edit?usp=sharing][abstract]]
** decent figures for phase advance and retreat 
*** [[figures/supra_phase.svg][phase retreat (roll)]]
*** [[figures/supra_ramp_phase.svg][phase advance (precession)]]
**** TODO: change roll->retreat; precession->advance in titles 
** implementing stimulation paradigm from Vaidya2013-sx
*** alternating dendritic exc (4) and somatic inh (2) at 7 hz 
*** exc: tau 3, e=0mV, 2mv somatic EPSP 
*** inh: tau 8, e=-80mV, 3nS conductance 
*** so far, very square looking 

* paper outline 
** Introduction 
*** Overview of subthreshold impedance and chirp 
Impedance characterizes the frequency dependent filtering properties of the 
neuronal membrane for small, subthreshold stimul. 
Impedance has been estimated in neurons by applying current stimulus in the form 
of either a chirp (sinusoidal signal whose instantaneous frequency increases with
time) or white noise and recording the resulting changes in membrane potential.
The ratio of the Fourier transformed \vmemb to the Fourier transformed current 
stimulus is the impedance, which has a real part (impedance amplitude), which 
characterizes frequency dependent signal attenuation, and an imaginary part 
(impedance phase), which characterizes the temporal relationship between the 
input stimulus and \vmemb.
This method only holds when the neuronal membrane behaves as a linear, time-
invariant/stationary system (i.e. for small, subthreshold inputs).
Since the primary outputs of neurons are action potentials, which are nonlinear 
[and nonstationary], impedance is inadequate for studying much of neuronal function.
*** Methods for suprathreshold analogous to impedance amplitude 
**** STA 
Spike-triggered averaging was the first method to try bridging the gap between 
subthreshold membrane potential oscillations and suprathreshold activity Bryant1976-ek.
For instance, hippocampal pyramidal neurons showed Ih-dependent selectivity for 
theta-frequency inputs comparable to their subthreshold resonsance Das2017-tb.
**** suprathreshold chirp shows spiking aroung the resonance frequency, but not
for the lowest frequencies or higher frequencies, in line with the bandpass 
nature of the membrane filtering properties Ulrich2002-dd.
**** nonlinear, subthreshold Pena2019-qv
At higher, but still subthreshold, intensities of stimulating current, the responses 
to excitation and inhibition become assymetric (nonlinear).  
Pena2019-qv extend impedance amplitude framework to assess these nonlinear voltage 
responses in a conductance based model neuron.
**** suprathreshold 
Fischer2017-jx used suprathreshold sinusoidal stimuli with constant frequencies to 
assess the the frequency dependence of spiking patterns in mechano-sensory neurons 
in leeches.  
By stimulating at various frequencies and either counting total number of spikes or 
computing spike frequency over a given duration, they developed another nonlinear 
analog to impedance amplitude.
*** Our method for suprathreshold analogous to impedance phase 
While these methods provide useful analogs to impedance amplitude for nonlinear 
regimes of neural activity, they ignore the temporal relationship between input 
and output captured by impedance phase in the subthreshold, linear regime.
To fill this gap, we stimulated a model neuron with suprathreshold sinusoidal 
current signals and registered the phase angles of the stimulus at which action 
potentials occurred. 
We found that for constant amplitude, sinusoidal currents of constant frequency, 
the stimulus phase at which an action potential was generated increased with 
successive stimulus cycles. We refer to this phenomemon as phase advance.
Conversely, for sinusoidal currents of constant frequency whose amplitude increased
over time, the stimulus phase at which an action potential was generated decreased
with successive stimulus cycles.  We refer to this as phase retreat.
Both scenarios serve to highlight the nonstationarity of the neuron in the nonlinear 
spiking regime of activity.
** Methods 
*** explanation of cell model, previous results for subthreshold 
**** Modified version of neocortical layer 5b pyramidal neuron from Hay2011-if 
which incorporates a combination of Ih and TASK-like shunting current described 
in Migliore2012-ev.
**** constant HCN channel density in the basal dendrites, exponentially increasing 
density with distance from the soma in apical dendrites.
**** This model was shown in Kelley2021-hr to have location-dependent, subthreshold 
impedance amplitude and, importantly, phase profiles in close agreement with 
experimental observations.  [In most other models of L5b PYR neurons, either the 
phase or amplitude profiles agreed with experiments, but usually not both].
**** more description from original paper . . . 
*** overview of stimulation paradigms 
**** chirp stimuli
When using a chirp stimulus, the instantaneous frequency of the waveform increased 
linearly from 0.5-20 Hz over a 20s duration.  
When using a chirp stimulus to demonstrate the subthreshold impedance properties of
the neuron, we chose a stimulus amplitude that produced symmetrical changes in Vmmeb 
about Vrest.
For suprathreshold chirp stimulus, we chose an amplitude sufficient to produce one 
spike per stimulus cycle when the stimulus frequency <12 Hz.  In order to produce
spiking for higher frequency stimuli, the amplitude would need to increase, which 
would elicit more spikes at the lower frequencies.
**** sinusoids 
Becasue the responses to suprathreshold stimuli were clearly nonstationary, we 
focused on sinusoidal stimuli with constant freqeuncy.
***** constant ampltiude sine
First, we used stimuli with a constant amplitude, and that amplitude was chosen to
elicit a single spike on each cycle of the stimulus. At lower amplitudes the cell
may only spike on the first stimulus cycle, and at higher amplitudes the cell may 
produce multiple spikes per stimulus cycle.
We repeated this stimulation for frequencies 2-9 Hz to asses the frequency dependence 
of the spike phase relationship.  
We also assesed the amplitude-dependence of the spike phase relationship for stimuli 
of a particular frequency. 
Location-dependence was assesed by comparing stimulation in the soma versus stimulation
in the apical dendrite. 
We evaluated the influence of Ih by blocking HCN channels throughout the neuron.
***** ramped sinusoid 
We stimulated both the soma and the apical dendrite (~300 um from the soma).
Next, we used stimuli with an amplitude that increased linearly over time. Here,
the neuron did not spike during the first couple (smalled amplitude) stimulus 
cycles, but by the end of the stimulation the neuron produced one spike per stimulus 
cycle.
Unless otherwise noted, the amplitude of the stimulus increased 1nA/s. 
We similarly assesed the frequency-, amplitude-, location-, and Ih-dependence of the
spike-phase relationship for stimuli of increasing amplitude.
** Results 
*** inadequacy of chirp for suprathreshold phase, need for sinusoids
Chirp stimulation was inadequate to characterize the relationship between stimulus 
phase and spiking because spiking activity is nonstationary.
In response to a chirp stimulus, the stimulus phase angle of each spike increased
monotonically as the stimulus frequency increases from 0.5 to 6 Hz.
At the lowest frequencies, the spikes preceded the peaks of the stimulus cycles.
At ~4Hz, the spiking activity was coincident with the peak of the stimulus cycle.
At higher frequencies, the spikes lagged behind the peaks of the stimulus cycles.
This monotonic increase broke down beyond 6 Hz with large jumps in the spike-phase 
relationship as stimulus frequeny increased.
This breakdown suggested that spiking activity was nonstationary so we probed the 
spike-phase relationship for sinusoidal stimuli of constant frequency to show how 
it changed over time.
*** phase advance of spiking relative to stimulus 
For particular combinations of sinusoidal stimulus amplitude and frequency, 
spike-phase increased over the course of stimulation, a phenomenon we termed phase 
advance.  
We used an 8 Hz, 1 nA sinusoidal stimulus near the soma as an example of phase 
advance. 
The first spike initiated 20deg before the peak of the stimulus cycle. 
The phase of each spike increased over the next six cycles, with the seventh 
spike occuring 25deg after the peak of the stimulus cycle.   
After the eighth stimulus cycle, the relationship between spikes and stimulus phase
remained relatively constant.
Phase advance was location dependent.  When stimulating the apical dendrite rather
than perisomatically, the spike-phase curve shifted upward, with the first spike 
occuring ~10deg before the stimulus cycle peak and the curve saturing at ~35deg
after the stimulus cycle.
Phase advance was also dependent on Ih.  Blocking the HCN channels eliminated 
phase advance, with spikes alternating every other stimulus cycle, and after the 
first spike the relationship between stimulus phase an+d spiking remains constant 
for the duration of the stimulus.
Using 1 nA amplitude stimuli, we showed that phase advance is frequency dependent.
At that amplitude, phase advance was clear at 8 Hz but not at other frequencies.
It should be noted, however, that there can be strong phase advance at different 
frequencies for different stimulus amplitudes (data not shown).
We also showed that for an 8 Hz stimulus, the spike-phase relationship changed with 
different stimulus amplitudes. Interestingly, the spike-phase curve did not change 
smoothly as the stimulus amplitude changed.
*** phase retreat of spiking relative to stimulus 
We also stimulated the neuron with sinusoidal current stimuli whose amplitude
increased linearly with time.  
For specific combinations of stimulus freqeuncyy and amplitude sweep, spike-phase 
decreased over the course of stimulation, a phenomemon we termed phase retreat. 
When stimulating the neuron near the soma with an 8 Hz stimulus whose amplitude 
increased by 1.9 nA/s, the first spike occurred ~25deg after the peak of the stimulus 
cycle, and spike-phase decreased until the fifth spike, which occurred ~30 deg 
before the peak of the stimulus cycle.  
Phase retreat was location dependent.  When stimulating the apical dendrite, 
rather than perisomatically, the spike-phase curve shifted upward, with the 
first spike occurrent ~55deg before the stimulus cycle peak. 
Spike-phase decreased with successive stimulus cycles, with the tenth spike 
occurring 20deg after the stimulus cycle peak.
Phase retreat was modulated, but not dependent on, Ih. Blocking HCN channels 
resulted in an upward shift in the spike-phase curve and a smaller range of 
stimulus spike-phases.
Phase retreat was dependent on stimulus frequency.  For a stimulus whose amplitude 
increased by 1.9 nA/s, the greatest degree of phase-retreat occurred for an 8 Hz 
stimulus, with either less phase retreat or spike-phase not decreasing monotonically
for stimuli of other frequencies. For other amplitudes, however, monotonic phase 
retreat occurred at other frequencies.
*** neuromodulation 
**** Can modulate the spike-phase curve via normodulation of Ih
**** Phase advance: Decreasing vhalfl shifts curve, shift 
curve upward (later spikes) beyond second spike/stim cycle. However, vhalfl=-91 produced later spike 
phase than baseline, but vhalfl=-92 produced an earlier spike than at baseline.
Increasing vhalfl conversely shifted the spike-phase curve downward (earlier spikes)
**** Phase retreat: same trend without first spike weirdness at vhalfl=-92
** Discussion 
*** recap and interpret results 
*** sinusoidal currents as models of rhythmic alternation of synaptic 
excitation and inhibition Vaidya2013-sx
*** modeling shows HCN regulates spike phase relative to LFP Sinha2015-lz
*** possible implications for phase precession and phase roll Sloin2022-pe 

* [2022-7-11 Mon] - TODOS 
** DONE: finalize figure 1 
*** current version [[figures/chirp_insufficiency.png][3 rows of panels, sub chirp, supra chirp, supra single freq]]]
*** alt: put stimulus traces on same axes as response 
*** alt: remove single freq stim figure, move to separate fig with traces for both retreat and advance
**** could also add traces to retreat and advance figs 
** DONE: address (or decide whether to address) neuromodulation 
*** look at Maki-Marttunen2022-lj or talk to joao and salva re reasonable values of vhalf   

* [2022-7-14 Thu] - neuromodulation
** increasing vhalfl for hcn reduces amplitude "threshold" and seems to increase 
phase advance, takes longer to "latch"
*** see supra_data/HayCellMig_soma_0_amp_0.6_offset_0.0_f0_8_f1_8_vhalfl_-80.json
 
* [2022-7-15 Fri] - more neuromodulation 
** from Maki-Marttunen2022-lj review re neuromdolator concentrations 
2. Concentrations of ACh and dopamine
In the referenced studies, the modulations of voltage dependency were performed by either
controlling intracellular cAMP through a glass pipette during the patch-clamp recording or by
the perfusion of the antagonist in the extracellular solution. The concentration of
neuromodulators reported by the submitting authors is likely beyond the physiological
operating range of cortical neurons reported previously.
For example, Hironaka et al. (2001) reported that the ACh concentration in the rat prefrontal
cortex ranged from 10 nM to 30 nM (PMID: 11368961). On the other hand, the dose of ACh
used in the referenced work (Zhao et al., 2016) used 50 μM of ACh. Additionally, Spühler
and Hauri (2013) developed a simulation allowing in silico estimation of dopamine
concentrations in prefrontal cortex (PMID: 23951205). Spühler and Hauri found that the
concentration of dopamine in the prefrontal cortex likely falls between 9.5 nM to 250 nM in
the steady state and 23.4 nM to 989 nM with 26 Hz phasic dopamine release. The submitting
authors instead refer to Byczkowicz et al. (2019), which used 200 μM of dopamine in their
study.
Zhao et al. (2016) and Byczkowicz et al. (2019) used doses of Ach and Dopamine,
respectively, that are more than 200 times high than what was previously reported as possible
in vivo. These doses may represent a non-physiological perturbation that are not ideal for a
simulation that attempts to reconstruct normal, physiological spiking activity.
The submitting authors need to adjust the effects of neuromodulators based on physiological
concentrations. If they find similar results as to what was reported here, then it’s interesting.
We thank the reviewer for this comment. There are indeed at least two ways of
experimentally studying the effects of cAMP-coupled neuromodulators on I h activation:
either applying the neuromodulator (or corresponding agonist) to the extracellular medium, or
directly applying cAMP (or cAMP pathway inhibitor) into the intracellular medium. Apart
from Zhao et al. 2016, all our references use the latter approach (although, as noted by thereviewer, Byczkowicz et al. also applied dopamine in a related experiment; and Zhao et al.
also find similar results using the latter approach) but similar magnitudes for voltage shifts
have been reported using the former approach. For example., Wu and Hablitz 2005
(PMC6725283) reported a depolarizing shift of the half-inactivation voltage of 7 mV by
application of 30 uM dopamine, while our references found shifts ranging from 4 to 17 mV
by increased intracellular cAMP. We now mention this on p. 18:
It should be noted that although the above data and the data on HCN2-channel modulation
[Byczkowicz et al., 2019] were based on measured effects of direct increase of intracellular
cAMP, voltage shifts of similar magnitude have been observed when dopamine was applied
in the extracellular medium (e.g., 30 μM dopamine shifted the half-inactivation voltage of I h
currents in layer I interneurons by +7 mV in [Wu and Hablitz, 2005]).
As for the neuromodulator concentrations used in our references, it is true that ACh
concentrations measured in the extracellular medium in vivo are within the nanomolar range
(as shown in e.g. Hironaka et al. 2001 mentioned by the reviewer), which is much smaller
than the in vitro experiment of Zhao et al., 2016. However, one should keep in mind that, in
vivo, the local, transient concentrations of ACh are much higher in the synaptic cleft and
other confined volumes near the post-synaptic neuron’s dendrites than the measured global
concentrations in the extracellular medium. In Barberis et al. 2011 (PMC3123770), it was
estimated that an ejection of 4000 GABA molecules implies a concentration pulse of
hundreds of 𝜇M in the synaptic cleft. Similar estimates were made for ACh in Aidoo, A. Y.,
& Ward, K. (2006), Mathematical and computer modelling, 44(9-10), 952-962. By contrast, a
neurotransmitter concentration of a nanomolar magnitude in the synaptic cleft would
correspond to a handful of neurotransmitter molecules. Thus, we do not consider the bath
concentrations used in our references exaggeratingly large (especially since the experiments
that directly altered intracellular cAMP concentrations yielded similar ranges of voltage
shifts), although we agree with the reviewer that further research with varied concentrations
would be enlightening.
To show the relevance of the chosen range of voltage shifts, we have included references to
additional experiments supporting our use of 5-10 mV shifts, namely Chen et al. 2001
(mentioned by the reviewer), Ulens and Tytgat 2001, Ludwig et al. 1998, Wang et al. 2001,
Ko et al. 2016 – see our response above. To further highlight the fact that smaller
neuromodulator concentrations can lead to large effects, we also refer to a study where 10 uM
serotonin application had significant effects on L5PC excitability, mediated by I h current. In
addition to the sentences added in response to the comment above, on p. 17 we write:
Moreover, similar to cholinergic M2 receptors, serotonergic 5HT1A receptors (Gi/o coupled)
shift the half-inactivation voltage of Ih currents toward hyperpolarized potentials [Ko et al.,
2016], and these receptors mediated an inhibitory net effect in a subgroup of prefrontal
cortical L5PCs [Elliott et al., 2018].
To discuss the future directions for detailed modelling of I h channels, we now write on p. 22:
Furthermore, modelling of intracellular cAMP concentration and its effects on the I h
activation would be beneficial since the concentration of cAMP varies across dendrites [Katz
and Clemens, 2001], and thus I h channels in one part of the dendritic tree may be more prone
to negative cAMP modulation and others to positive one.
** nice results for altering vhalfl for both advance and retreat 
** probably want to user smaller slope for ramped sine / phase retreat figures 

* [2022-7-17 Sun] - neuromodulation figure  

* [2022-7-22 Fri] - starting paper 
** started paper on overleaf 

* [2022-8-3 Wed] - paper notes 
** Kamondi1998-rd
*** used two compartment (soma and dendrite) model of CA1 pyramidal cell without ih 
from Pinsky1994-fy
*** stimulated dendrite and soma with sinusoidal currents and observed "spike phase precession"
*** "To mimic the passage of a rat across the place field, let us suppose that 
the excitatory drive to the neuron's dendrite is gradually increased as the rat 
enters and moves across the place field."

* [2022-8-18 Thu] - focusing on apical stim for phase retreat 
** reasoning:
*** more dramatic drop in spike-phase over cycles 
*** clearly monotonic decrease 
*** no doublets, will look better (and consistent) for the trace 
*** more clear amplitude dependence 
*** follows more closely from buzsaki paper 

* [2022-9-15 Thu] - synaptic stims 
** still looks ugly, but got something that looks like phase retreat w/ ff inhibition 
*** excitatory 
oblq_secs = [9, 87, 105, 19]#, 101]
gmaxs = [0.01*12, 0.004*12, 0.0027*12, 0.006*12]#, 0.0038/4]
*** inhibitory
peri_secs = [0, 7]
inh_syns[sec_num][-1].gmax = 0.003 * 50 
** very hard to oscillations symmetrical about vmemb

* [2022-9-21 Wed] - asym phase and synaptic stims 
** adapted framework from Pena et al for asymmetric impedance amplitude for 
asymetric impedance phase
*** clear differences between upper envelope and lower envelope 
*** can use for spiking activity 
** synaptic stims 
*** tried sampling gmax for AMPA and GABA synapses from sinusoid - very tricky 
*** trying alternating excitatory and inhibitory Exp2Syn - still very tricky 
**** weights need to be asymmetric for symmetric voltage excursions 
**** not sure what the point is if synapses are so highly contrived (trying to get 
as close to sin as possible)

* [2022-9-26 Mon] - nonlinear phase computations 
** new fig - comparison of of linear to nonlinear phase, amplitude/asymmetry 
dependence, holding voltage dependence, h-current dependence, location dependence 

* [2022-10-3 Mon] - back to manuscript 
** email people with nonlinear responses?

* [2022-10-21 Fri] - rewriting results 
** questions for bill:
*** why sychrony point?  anything wrong with synchronous  frequency?  it's what we used in the last paper 

* [2022-10-25 Tue] - channel conductances 
** recording channel conductances at soma for subthreshold asym responses fig 
*** doesn't really make sense for comparison between somatic and apical stim 
where to record? 
** bill's alternative: graph amplitude sensitivity against tau for m,h for each ?
*** /usr/site/nrniv/local/python/mhn.py 
**** doesn't work on neurosim or locally, problem w/ h.usetables, seg fault if comment out 
**** just an idea;tau is a voltage-sensitive param that defines a response time for that channel

* TODOS 
** DONE: address advance/retreat at other frequencies (i.e. different amplitudes)
*** leaving be for right now.  can mention in text for phase advance. clearly visible for 
retreat
** DONE: rerun retreat sims for slope 0.5 
*** running locally 
** DONE: reverse order of plots for neuromod figure 
** DONE: manipulate gmax for ih 
*** decreases in gbad_hd had minimal effects, but increasing it quickly resulted 
in unexcitability, for now going to leave out, but raises the question of whether 
it's better off using M1 cell
** DONE: decide whether blocking Ih should go into neuromodulation or leave where it is 
*** staying where it is 
** DONE: need to decide whether to use slope factor of 1 (which has spike doublets) 
or 0.5 (which is not quite monotonic) for phase retreat / ramp chirp
** DONE: include bandpassed spiking mentioned in Ulrich in intro 
** DONE: consider focusing on dendritic stimulation for phase retreat 
*** much nicer
** DONE: consider replacing amplitude panels with mean/holding current 
*** seems to make a sizeable difference for phase advance, not so much for phase retreat 
** DONE: consider adding comparison between phase advance and spike frequency adaptation 
*** at least include in mention in text 
** DONE: rerun neuromodulation for apical dendrite / phase retreat 
** DONE: finalize figs - want consistent representations for "base" stimuli 
** DONE: rewrite results (and anything else) to reflect switch of focus to apical 
** DONE: incorporate discussion of buzsaki paper 
** DONE: add refs for impedance in intro 
** DONE: add simulations/code availablity section to methods 
** DONE: finish plot showing traces and impedance phase for linear sub, nonlinear sub, supra w/ TTX, and supra 
** DONE: convert other figures from phase via hilbert to new method 
** DONE: consider new fig explaining method 
*** looks crummy 
** DONE: neuromodulation for nonlinear, subthreshold 
** DONE: rewrite text accordingly 
*** finished through results, need to do discussion 
*** DONE: introduce inductive phase?
**** for now, no
*** DONE: introduce leading phase and synchronous frequency in methods 
** DONE: change resting vmemb to holding vmemb 
** DONE: new RMPs
** DONE: maybe new amplitudes 
** TODO: maybe add methods fig
** TODO: remove neuromod 
*** rationale: two vhalfs in .mod, tiny effects, enough going on without it 
** TODO: try extracting exp data from ulrich 
*** really noisy, webplotdigitizer doesn't sample evenly
*** didn't need exp data for first paper 